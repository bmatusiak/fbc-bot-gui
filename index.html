<!DOCTYPE html>
<html lang="en">
<script>

var botDir = "..\\..\\";
var botExe = "freebitco.exe"


//for chart
var updateInterval = 60; 
var dataLength = 1000 * 30 ; // number of dataPoints visible at any point


</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<body>

<table>

<tr>

<td  style="white-space:nowrap;">
<table >
<tr>
	<td>Wins</td>
	<td id="botWins"></td>
</tr>
<tr>
	<td>Losses</td>
	<td id="botLooses"></td>
</tr>
<tr>
	<td>Totals Amount Bet</td>
	<td id="totalBets"></td>
</tr>
<tr>
	<td>Biggest Losing Streak</td>
	<td id="BLS"></td>
</tr>
<tr>
	<td>Current Losing Streak</td>
	<td id="CLS"></td>
</tr>
<tr>
	<td>Multiplier</td>
	<td id="M"></td>
</tr>
<tr>
	<td>Target Balance</td>
	<td id="tBalance"></td>
</tr>
<tr>
	<td>High Balance</td>
	<td id="hBalance"></td>
</tr>
<tr>
	<td>Current Balance</td>
	<td id="cBalance"></td>
</tr>
<tr>
	<td>Low Balance</td>
	<td id="lBalance"></td>
</tr>
<tr>
	<td>Starting Balance</td>
	<td id="sBalance"></td>
</tr>
<tr>
	<td>Biggest Single Bet</td>
	<td id="BB"></td>
</tr>
<tr>
	<td>Current Bet</td>
	<td id="B"></td>
</tr>
<tr>
	<td>Biggest Draw Down</td>
	<td id="BDD"></td>
</tr>
<tr>
	<td>Total Bet</td>
	<td id="TB"></td>
</tr>
<tr>
	<td>Gain</td>
	<td id="gain"></td>
</tr>
<tr>
	<td>Target Amount</td>
	<td id="targetAmount"></td>
</tr>
<tr>
	<td>Session Time</td>
	<td id="ST"></td>
</tr>
<tr>
	<td>Progress</td>
	<td id="ProgressT"></td>
</tr>
</table>

</td>


<td  style="width:100%">

<div id="chartContainer" style="height: 400px; width:100%;"></div>

</td>
</tr>
</table>

<div id="progressBar" style="height:25px;width:100%;background-color:gray;"><div id="progress" style="height:25px;width:0%;background-color:green;"></div></div>

<div>

<button id="startStop">Start</button> | 
<input id ="testMode" type="checkbox" checked="checked" />TestMode | 
<button id="clearChart">Clear</button> | 

<br/>
<br/>
<button id="showDevConsole">DevConsole</button> | 
</div>
<script>

var modules = {};
modules.path = require("path");
modules.fs = require('fs');

botDir = modules.path.join(global.__dirname,botDir);

// Get the current window
var win = nw.Window.get();
var openProcesses = [];
win.on('close', function() {
  this.hide(); // Pretend to be closed already
  console.log("We're closing...");
  for(var i in openProcesses){
	openProcesses[i].process.kill('SIGINT');
	delete openProcesses[i];
  }
  //alert("close");
  this.close(true); // then close it forcely
});

$("#showDevConsole").click(function(){
	win.showDevTools()
});

function startProcessBotProcess(args,outputAction,onExit){
	
	if(!modules.fs.existsSync(botDir + botExe)){
		alert("file not exist: "+botDir + botExe);
		win.close();
		return;
	}
	var spawn = require('child_process').spawn,
		app = spawn(botDir + botExe, args,
				{ 	
					cwd: botDir,
					env: process.env
				});

	app.stdout.on('data', function (data) {
	  //console.log('stdout: ' + data);
	  if(outputAction){
		var splitData = data.toString().split("\n");
		
		for(var i in splitData){
			try{
				var $data = JSON.parse(splitData[i]);
				if(typeof $data == "object")
					outputAction($data);
			}catch(e){}
		}
	  }
	});

	app.stderr.on('data', function (data) {
	  console.log('stderr: ' + data);
	});

	app.on('exit', function (code) {
	  console.log('child process exited with code ' + code);
	  if(onExit) onExit();
	});
	openProcesses.push({
		id : (new Date).getTime(),
		process : app
	});
	
	return app;
}


var dpsBALANCE_TIME = []; // dataPoints
var dpsLOOSING = []; // dataPoints

var chart = new CanvasJS.Chart("chartContainer", {
	animationEnabled: true,
	axisY: {
		includeZero: false
	}, 
	axisX: {
		includeZero: false,
		labelFormatter: function(){
		  return " ";
		}
	},
	axisX2: {
		includeZero: false,
		labelFormatter: function(){
		  return " ";
		}
	},
	data: [{
		type: "line",
		color:"red",
		axisXType: "secondary", 
		axisYType: "secondary", 
		dataPoints: dpsLOOSING
	},{
		type: "line",
		color:"blue",
		dataPoints: dpsBALANCE_TIME
	}]
});

var xVal = 0;
var yVal = 0; 
var updateChart = function (x , y, Y2) {

	dpsBALANCE_TIME.push({
		x: x,
		y: y
	});
	
	dpsLOOSING.push({
		x: x,
		y: Y2
	});
	

	if (dpsBALANCE_TIME.length > dataLength) {
		dpsBALANCE_TIME.shift();
	}
	if (dpsLOOSING.length > dataLength) {
		dpsLOOSING.shift();
	}

	//chart.render();
};

$("#clearChart").click(function(){
	while(dpsBALANCE_TIME.length) {
		dpsBALANCE_TIME.shift();
	}
	while (dpsLOOSING.length) {
		dpsLOOSING.shift();
	}
});
//chartUpdater
setInterval(function(){chart.render();}, updateInterval);

var botProcess;
var running = false;
var fullsessioncount = 0;
//start
var startStop = function(){

	if(!running){
		running = true;
		$("#startStop").text("Stop")
		
		var args = ["dice"];
		if($('#testMode:checked').length)
			args.push("test");
			
		if(!confirm("starting bot: "+args.toString()))
			return;
			
		botProcess = startProcessBotProcess(args,function(dataObject){
		if(dataObject.msg) console.log(dataObject.msg);
		
		if(dataObject.msg && dataObject.msg.indexOf("Stopped") == 0){
			 var thePrompt = confirm(dataObject.msg);
			 
			 if(thePrompt){
				botProcess.stdin.write("\n");
			 }
			return;
		}

		$("#botWins").text(dataObject.W)
		$("#botLooses").text(dataObject.L)
		$("#totalBets").text(dataObject.ID)
					
					
		$("#BLS").text(dataObject.BLS)
		$("#CLS").text(dataObject.CLS)
		$("#cBalance").text(dataObject.C)
		$("#sBalance").text(dataObject.S)
		$("#TB").text(dataObject.T)//totalBets
		$("#hBalance").text(dataObject.HL.split("/")[0] )
		$("#lBalance").text(dataObject.HL.split("/")[1] )
		$("#BB").text(dataObject.BB)
		$("#BDD").text(dataObject.BDD)
		$("#tBalance").text(dataObject.TB)//targetBalance
		$("#ST").text(dataObject.ST)
		$("#B").text(dataObject.B)
		$("#M").text(dataObject.M)
		
		
		
		var targetBalance = parseFloat(dataObject.TB);
		var highestBalance = parseFloat(dataObject.HL.split("/")[0]);
		
		var targetAmount = targetBalance - dataObject.S;
		var gain = highestBalance - dataObject.S;
		
		$("#gain").text(gain.toFixed(8));
		$("#targetAmount").text(targetAmount.toFixed(8));
		
		var progress = (gain / targetAmount)* 100;
		
		$("#ProgressT").text(progress.toFixed(2)+"%");
		$("#progress").css("width",progress+"%");
		
		++fullsessioncount;
		updateChart(fullsessioncount, parseFloat(dataObject.C), dataObject.CLS);
		
	})
	}else{
		botProcess.kill('SIGINT');
		running = false;
		$("#startStop").text("Start")
	}
};

$("#startStop").click(startStop);
</script>

</body>

</html>
